name: Docs CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: docs-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gate:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # mike needs full history; also needed for gitleaks

      # ── Secret scanning ──────────────────────────────────────────────────
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Node toolchain ───────────────────────────────────────────────────
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install Node deps
        run: npm ci

      # ── Markdown lint ────────────────────────────────────────────────────
      - name: Markdown lint
        run: npx markdownlint-cli2 "docs/**/*.md"

      # ── OpenAPI validation ───────────────────────────────────────────────
      - name: Validate OpenAPI spec(s)
        run: npx @quobix/vacuum lint docs/reference/openapi/*.yaml

      # ── Python toolchain ─────────────────────────────────────────────────
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Python deps
        run: pip install -r requirements.txt

      # ── Docs build (strict) ──────────────────────────────────────────────
      - name: Build docs (strict)
        run: mkdocs build --strict

      # ── Internal link check ──────────────────────────────────────────────
      - name: Internal link check
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --offline
            --include-fragments
            --no-progress
            'site/**/*.html'
          fail: true

      # ── External link check (warning only) ───────────────────────────────
      - name: External link check (warning)
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --no-progress
            --exclude-path site/assets
            'site/**/*.html'
          fail: false          # warning only; does not block merge
