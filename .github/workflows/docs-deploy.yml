name: Docs Deploy

on:
  push:
    branches: [main]
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write      # mike writes to git history / local dir
  id-token: write      # OIDC if using federated identity instead of API token

concurrency:
  group: docs-deploy
  cancel-in-progress: false   # never cancel a deploy mid-flight

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ── Python toolchain ─────────────────────────────────────────────────
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install Python deps
        run: pip install -r requirements.txt

      # ── Resolve version identifier ────────────────────────────────────────
      - name: Resolve version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"               # e.g. v1.2.3
            VER="${TAG#v}"                              # strip leading v → 1.2.3
            ALIAS="${VER%.*}"                           # strip patch → 1.2
            echo "alias=${ALIAS}"   >> "$GITHUB_OUTPUT"
            echo "update_latest=true"  >> "$GITHUB_OUTPUT"
          else
            echo "alias=dev"        >> "$GITHUB_OUTPUT"
            echo "update_latest=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Build versioned snapshot with mike ────────────────────────────────
      - name: Deploy (tag → MAJOR.MINOR + latest)
        if: steps.version.outputs.update_latest == 'true'
        run: |
          mike deploy \
            --update-aliases \
            "${{ steps.version.outputs.alias }}" latest
          mike set-default latest

      - name: Deploy (main → dev)
        if: steps.version.outputs.update_latest == 'false'
        run: |
          mike deploy \
            --update-aliases \
            dev
          mike set-default dev

      # ── Check out gh-pages content for SWA ───────────────────────────────
      # mike commit the built site to a local gh-pages branch. Check it out
      # into a worktree so the SWA action has a directory of artefacts to deploy.
      - name: Prepare gh-pages worktree
        run: |
          git worktree add ./gh-pages-site gh-pages
          cp staticwebapp.config.json gh-pages-site/

      # ── Deploy to Azure Static Web Apps ───────────────────────────────────
      - name: Deploy to Azure SWA
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: "gh-pages-site"
          output_location: ""
          skip_app_build: true

      # ── Push gh-pages to remote (preserve mike versioning history) ────────
      - name: Push gh-pages
        run: git push origin gh-pages

      # ── Post-deploy smoke test ────────────────────────────────────────────
      - name: Smoke test
        env:
          TARGET_VERSION: ${{ steps.version.outputs.alias }}
          DOCS_BASE_URL: ${{ vars.DOCS_BASE_URL }}    # set as repo variable (not secret)
        run: bash scripts/smoke-test.sh
